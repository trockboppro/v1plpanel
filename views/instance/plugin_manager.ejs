<%- include('../components/template') %>

<style>
/* --- General Styles --- */
body {
    color: #b0bac5;
}

.file-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 1rem;
    padding: 1rem;
}

.file-card {
    background-color: rgba(255,255,255,0.05);
    border-radius: 1rem;
    padding: 1rem;
    text-align: center;
    transition: transform 0.2s ease, background-color 0.2s ease, box-shadow 0.2s ease;
}

.file-card:hover {
    transform: scale(1.05);
    box-shadow: 0 2px 8px rgba(255,255,255,0.4);
}

/* --- Plugin Styles --- */
.plugin-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 1rem;
}

.plugin {
    background-color: #26292f;
    border-radius: 25px;
    width: 300px;
    padding: 1rem;
    text-align: center;
    transition: transform 0.15s ease, box-shadow 0.15s ease;
}

.plugin:hover {
    transform: scale(1.05);
    box-shadow: 0 2px 8px rgba(255,255,255,0.61);
}

.plugin h3 {
    font-size: 1.2rem;
    margin-bottom: 0.5rem;
}

.plugin p {
    font-size: 0.9rem;
    color: #b0bac5;
}

.plugin button, .plugin a {
    margin-top: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    background-color: #007bff;
    color: #b0bac5;
    text-decoration: none;
    transition: transform 0.2s ease, background-color 0.2s ease;
}

.plugin button:hover, .plugin a:hover {
    transform: scale(1.05);
    background-color: #0056b3;
}

/* --- Loading / Overlay / Toast --- */
.loading-overlay {
    position: fixed;
    inset: 0;
    background-color: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
    z-index: 9999;
}
.loading-overlay.active {
    opacity: 1;
    visibility: visible;
}

.spinner {
    border: 4px solid rgba(255,255,255,0.3);
    border-radius: 50%;
    border-top: 4px solid #ffffff;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.toast {
    position: fixed;
    bottom: 1rem;
    right: 1rem;
    background-color: #4CAF50;
    color: white;
    padding: 1rem;
    border-radius: 0.5rem;
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: 10000;
}
.toast.show {
    opacity: 1;
}

/* --- Modal --- */
#installModal {
    position: fixed;
    inset: 0;
    background-color: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
    z-index: 10000;
}
#installModal.active {
    opacity: 1;
    pointer-events: auto;
}
#installModal .modal-content {
    background-color: #1a1c20;
    padding: 2rem;
    border-radius: 1rem;
    max-width: 400px;
    width: 100%;
    transform: scale(0.95);
    transition: transform 0.3s ease;
}
#installModal.active .modal-content {
    transform: scale(1);
}
</style>

<main class="container mx-auto px-4 py-6">

<h2 class="text-xl font-semibold text-center mb-4">Plugins</h2>

<!-- Search -->
<div class="mb-4">
    <input 
        type="text" 
        id="searchInput" 
        placeholder="Search plugins..." 
        class="w-full p-2 rounded-lg bg-white/10 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500"
    />
</div>

<!-- Plugin Grid -->
<div id="pluginContainer" class="plugin-container">
    <div id="loading" class="text-center w-full">Loading plugins...
        <div class="spinner mt-4"></div>
    </div>
</div>

<!-- Load More -->
<div class="text-center mt-4">
    <button id="loadMore" class="px-4 py-2 bg-lime-950 text-lime-400 rounded-md hover:brightness-150 transition">Load More</button>
</div>

</main>

<!-- Install Modal -->
<div id="installModal">
    <div class="modal-content">
        <h2 class="text-2xl font-medium text-white mb-4">Installing Plugin</h2>
        <div class="w-full bg-neutral-700 rounded-full h-2.5 mb-4">
            <div id="installProgress" class="bg-lime-400 h-2.5 rounded-full" style="width: 0%;"></div>
        </div>
        <p id="installStatus" class="text-center text-gray-300">Preparing install...</p>
    </div>
</div>

<!-- Toast -->
<div id="toast" class="toast">Operation completed successfully</div>

<script>
const API_URL = "https://api.spiget.org/v2/resources/free";
const ITEMS_PER_PAGE = 50;
let currentPage = 1;
let allPlugins = [];

// Fetch Plugins
async function fetchPlugins(page=1) {
    const container = document.getElementById('pluginContainer');
    const loading = document.getElementById('loading');
    const loadMoreButton = document.getElementById('loadMore');
    loading.style.display = 'block';
    try {
        const res = await fetch(`${API_URL}?size=${ITEMS_PER_PAGE}&page=${page}&sort=-downloads`);
        const plugins = await res.json();
        allPlugins = [...allPlugins, ...plugins];
        renderPlugins(allPlugins);
        loading.style.display = 'none';
        if (plugins.length < ITEMS_PER_PAGE) loadMoreButton.style.display = 'none';
    } catch(e) {
        console.error(e);
        loading.innerText = "Error loading plugins.";
    }
}

// Render Plugins
function renderPlugins(plugins) {
    const container = document.getElementById('pluginContainer');
    container.innerHTML = '';
    plugins.forEach(plugin => {
        const div = document.createElement('div');
        div.className = 'plugin';
        div.innerHTML = `
            <h3>${plugin.name}</h3>
            <p>‚≠ê ${plugin.rating.average} | ${plugin.downloads.toLocaleString()} downloads</p>
            <div class="flex justify-center gap-2 mt-2">
                <button onclick="installPlugin('${plugin.id}','${plugin.name}')">Download</button>
                <a href="https://spigotmc.org/resources/${plugin.id}" target="_blank">Visit</a>
            </div>
        `;
        container.appendChild(div);
    });
}

// Search Plugins
document.getElementById('searchInput').addEventListener('input', e => {
    const val = e.target.value.toLowerCase();
    const filtered = allPlugins.filter(p => p.name.toLowerCase().includes(val));
    renderPlugins(filtered);
});

// Load More
document.getElementById('loadMore').addEventListener('click', () => {
    currentPage++;
    fetchPlugins(currentPage);
});

// Install Plugin
function installPlugin(id, name) {
    const modal = document.getElementById('installModal');
    const progress = document.getElementById('installProgress');
    const status = document.getElementById('installStatus');
    modal.classList.add('active');
    progress.style.width = '0%';
    status.innerText = `Installing ${name}...`;

    // Simulate progress
    let pct = 0;
    const interval = setInterval(() => {
        pct += Math.random()*15;
        if (pct >= 100) {
            pct = 100;
            clearInterval(interval);
            status.innerText = `${name} installed successfully!`;
            setTimeout(()=>modal.classList.remove('active'), 1500);
            showToast('Plugin installed successfully');
        }
        progress.style.width = pct + '%';
    }, 300);

    // Real install redirect (if needed)
    window.location.href = `/instance/<%= req.params.id %>/plugins/download/${id}/${encodeURIComponent(name)}`;
}

// Toast
function showToast(msg) {
    const toast = document.getElementById('toast');
    toast.innerText = msg;
    toast.classList.add('show');
    setTimeout(()=>toast.classList.remove('show'), 3000);
}

// Initial fetch
fetchPlugins(currentPage);
</script>
