<%- include('../components/template') %>
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.0/min/vs/loader.js"></script>

<main id="content" class="min-h-screen text-yellow-100">

  <!-- Header -->
  <div class="bg-transparent">
    <div class="sm:flex sm:items-center px-8 pt-4">
      <div class="sm:flex-auto">
        <h1 class="text-base font-medium leading-6 text-yellow-300">
          Manage Instance
        </h1>
        <p class="mt-1 tracking-tight text-sm text-yellow-400/60">
          View, update and manage an instance on the <%= name %> panel.
        </p>
      </div>
    </div>
  </div>

  <%- include('../components/instance') %>

  <% let query = req.query.path ? '?path=' + req.query.path : ''; %>

  <!-- Path & Filename -->
  <div class="flex items-center px-8 mt-4">
    <h1 class="text-yellow-300 text-sm font-mono">
      <a href="../"
         class="text-yellow-500/60 hover:text-yellow-400 transition">
        /app/data/<%= req.query.path %>
      </a>
    </h1>

    <input
      id="filename"
      type="text"
      name="filename"
      placeholder="file.txt"
      class="ml-4 w-96
             rounded-xl
             bg-black/40 border border-yellow-500/20
             px-4 py-2 text-sm text-yellow-200
             placeholder:text-yellow-500/30
             hover:border-yellow-500/40
             focus:border-yellow-500 focus:ring-0
             transition"
    />
  </div>

  <!-- Editor -->
  <div
    id="editor"
    class="mx-8 mt-6 rounded-2xl overflow-hidden
           border border-yellow-500/20
           shadow-xl shadow-yellow-500/5"
    style="height: 500px;">
  </div>

  <!-- Actions -->
  <div class="flex mt-8 space-x-4 px-8">

    <!-- Back -->
    <a href="/instance/<%= req.params.id %>/files"
       class="rounded-xl
              bg-transparent border border-yellow-500/20
              hover:bg-yellow-500/10
              px-4 py-2 text-sm text-yellow-300
              transition shadow-lg">
      Back
    </a>

    <!-- Create -->
    <button
      id="saveButton"
      onclick="saveFile()"
      type="button"
      class="rounded-xl
             bg-yellow-400 hover:bg-yellow-500
             text-neutral-900 font-medium
             px-4 py-2 text-sm
             shadow-lg shadow-yellow-500/30
             hover:scale-95 transition">
      Create File
    </button>

  </div>

<script>
require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.0/min/vs' }});
require(['vs/editor/editor.main'], function () {
    var editor = monaco.editor.create(document.getElementById('editor'), {
        theme: 'vs-dark',
        fontSize: 14,
        minimap: { enabled: false }
    });
    window.editor = editor;
});

function saveFile() {
    var button = document.getElementById('saveButton');
    button.disabled = true;
    button.textContent = 'Working on it...';

    var fileContent = window.editor.getValue();
    var instanceId = <%- JSON.stringify(req.params.id) %>;
    const filename = document.getElementById('filename').value;

    fetch(`/instance/${instanceId}/files/create/${filename}<%= query %>`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content: fileContent })
    })
    .then(res => res.json())
    .then(data => {
        if (data && data.message) {
            button.textContent = 'Done!';
            setTimeout(() => {
                button.disabled = false;
                button.textContent = 'Create File';
            }, 1000);
        } else {
            alert('Error creating file');
            button.disabled = false;
            button.textContent = 'Create File';
        }
    })
    .catch(err => {
        console.error(err);
        alert('Failed to create the file.');
        button.disabled = false;
        button.textContent = 'Create File';
    });
}
</script>

</main>
<%- include('../components/footer') %>
